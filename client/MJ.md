# 運営の方へ AIの動かし方
Google Colab を編集しただけなのでSampleCliant()と同じように動かせます。

# コヨーテAI：ベイズ推定による戦略的意思決定モデル

## 1. はじめに

このドキュメントは、カードゲーム「コヨーテ」をプレイするAI（Artificial Intelligence）の設計と思考プロセスについて解説します。コヨーテは、各プレイヤーが自分だけ見ることのできないカードを一枚持ち、全プレイヤーのカードの合計値を宣言し合うブラフと推理のゲームです。本AIは、不完全な情報の中で論理的な推論を行い、勝利確率を最大化することを目指します。その核となる技術が「ベイズ推定」です。

## 2. AIの思考の核心：ベイズ推定

AIがゲームの状況を判断し、次の一手を決定するための根幹を成すのがベイズ推定です。これは、**既存の知識や情報に基づく「最初の予測（事前確率）」を、新たに観測された事実（データ）によって、より確からしい「更新された予測（事後確率）」へと改善していく統計的な推論手法**です。

コヨーテのゲーム進行において、AIは以下のサイクルで思考を深めていきます。

1.  **初期状況の分析**: ゲーム開始時やラウンドの初めに、自分の手札の可能性や、それに基づく全体の合計値の確率分布（事前分布）を計算します。
2.  **他者の行動の観測**: 他のプレイヤーが宣言する数値や、「コヨーテ」と宣言しなかったという事実を新たなデータとして観測します。
3.  **尤度の評価**: 観測されたデータが、AIが持つ「もし真の合計値が〇〇だったら…」という各仮説のもとで、どれくらい起こりやすかったかを評価します（尤度）。
4.  **予測の更新**: 事前分布と尤度をベイズの定理に従って組み合わせ、より精度の高い合計値の確率分布（事後分布）を導き出します。
5.  **意思決定**: 更新された事後分布に基づき、最も合理的な行動（「コヨーテ」と宣言するか、新たな数値を宣言するか）を選択します。

このプロセスを繰り返すことで、AIはゲームが進むにつれて状況認識の精度を高め、より的確な判断を下せるようになります。

## 3. 具体的な処理の流れ

### ステップ1：初期状況の分析と「最初の予測」（事前分布の作成）

AIはまず、入手可能な全ての情報から、ゲームの盤面を把握し、自身の初期予測を形成します。

* **情報収集**:
    * ゲームで使用される全カードの種類と構成（例：-10が1枚、0が3枚、特殊効果を持つカード100番が1枚など）。
    * 他のプレイヤーたちが公開している（自分からは見える）カードの値。
    * 自分から見える他のプレイヤーのカードの合計値（これを`see_sum`とします）。

* **自分の手札の可能性の絞り込み**:
    全カードのリストから、他のプレイヤーが公開しているカードを除外します。残ったカードが、AI自身の（見えない）手札である可能性のあるカード群（`my_possible_cards`）となります。

* **考えうる「総合計値」の列挙と確率計算**:
    `my_possible_cards`に含まれる各カードについて、「もし自分の手札がこのカードだったら、全体の合計値はいくつか？」という計算を全ての候補カードに対して行います。
    * **通常カードの場合**: `see_sum`（他の人の見えているカードの合計）に、自分の候補カードの値を加算します。
    * **特殊カードの場合**: 各特殊カードは、その定義された効果に従って総合計値の計算に影響を与えます。例えば、AIのコードでは以下のような効果が考慮されています。
        * カード100番：もしAIの手札がこれなら、総合計値は `see_sum` の2倍になる。
        * カード101番：もしAIの手札がこれなら、総合計値は `see_sum` から、他のプレイヤーの公開カードの中の最大値を引いた値になる。
        * カード102番：もしAIの手札がこれなら、総合計値は `see_sum` に1を加えた値になる。
        * （カード103番など、他の特殊カードも同様に固有のルールに基づいて合計値が計算されます。）

    こうして計算された「あり得る総合計値」の候補（`possible_sums`）が多数集まります。これらの候補の中で、各合計値がどれくらいの頻度で出現したかを数え上げ、その総数で割ることで、それぞれの合計値に対する初期の確率を算出します。これがAIの「最初の予測」である**事前確率分布**（`p_list`）となります。このAIでは、考慮する合計値の範囲（`sum_range`）を例えば-20から140程度に設定しています。

### ステップ2：他者の行動からの「気づき」（尤度の設定と事後分布への更新）

ゲームが進行し、他のプレイヤーが行動すると、AIはその情報を基に自身の予測を更新します。

* **観測データ**: 最も重要な観測データは、「あるプレイヤーが『コヨーテ』と宣言せずに、特定の数値 `act` を宣言した」という事実です。これは、そのプレイヤーが「真の合計値は少なくとも `act` 以上だろう」と（本心かブラフかは別として）考えていることを示唆します。

* **尤度（ゆうど）の設定**:
    AIは、観測された宣言 `act` を元に、各合計値の仮説に対する尤度を設定します。尤度とは、「もし真の合計値が特定の候補値 `true_sum_candidate` だったら、相手が `act` と宣言する（コヨーテと言わない）のはどれくらいあり得そうか？」という度合いです。このAIでは、以下のようなシンプルなモデルを採用しています。
    * もし `true_sum_candidate` が相手の宣言 `act` よりも**小さい**場合：相手が実際より大きく宣言していることになるため、その `true_sum_candidate` の下ではこの宣言は起こりにくいと考え、尤度を低い値（例: 0.1）に設定します。
    * もし `true_sum_candidate` が相手の宣言 `act` 以上である場合：相手の宣言は妥当か控えめであるため、その `true_sum_candidate` の下ではこの宣言は起こりやすいと考え、尤度を高い値（例: 0.9）に設定します。

* **ベイズ更新による確率分布の更新**:
    計算された事前確率と尤度を使い、ベイズの定理に基づいて事後確率を計算します。具体的には、各合計値候補について「事前確率 × 尤度」を計算し、それらの合計が1になるように正規化（全ての値をその合計値で割る）します。これにより、新たな観測データを加味した、更新された合計値の確率分布（`p_list`）が得られます。
    ゲームのログ（`log`）に記録された過去の各宣言についても、この尤度計算とベイズ更新を順番に適用していくことで、AIの予測はより精緻化されていきます。

### ステップ3：学習結果に基づく「行動決定」

最新の事後確率分布（`p_list`）に基づき、AIは自身の行動を決定します。

* **コヨーテ宣言の判断**:
    現在の場に出ている最後の宣言値 `act` に対し、「真の合計値が `act` よりも大きい確率」を事後確率分布から計算します。この確率が一定の閾値（例: 0.5、つまり50%）よりも**低い**場合、AIは「現在の宣言 `act` は過大であり、真の合計値は `act` 以下である可能性が高い」と判断し、「コヨーテ」と宣言します（アクション値 `-1`）。ただし、ラウンド最初の宣言者（`act` が初期値の場合）はこの限りではありません。

* **数値宣言の戦略**:
    「コヨーテ」と宣言しない場合、AIは `act` よりも大きな数値を宣言する必要があります。
    * **ラウンド最初の宣言の場合**: AIは固定値（例: 1）を宣言します。
    * **それ以降の宣言の場合**: AIは、更新された事後確率分布の中で、`act` よりも大きい範囲に注目します。その範囲内で最も確率が高い（最もありえそうだとAIが考えている）合計値を選択し、宣言します。具体的には、`act` に1を加えた値から始まる合計値の範囲で、最大の確率を持つ合計値を次の宣言値とします。
